name: Wake Backend Server

on:
  schedule:
    # Run at 11:57 PM UTC every day (3 minutes before midnight)
    # This ensures the server is awake when the scheduler runs at midnight
    - cron: "57 23 * * *"
  workflow_dispatch: # Allow manual trigger from GitHub Actions tab

jobs:
  wake-server:
    runs-on: ubuntu-latest
    steps:
      - name: Wake up backend server
        env:
          BACKEND_URL: ${{ secrets.BACKEND_URL }}
          SCHEDULER_API_KEY: ${{ secrets.SCHEDULER_API_KEY }}
        run: |
          echo "üîî Waking up backend server at $(date)"
          echo "Backend URL: $BACKEND_URL"

          # Retry up to 3 times with 30-second delays
          for i in {1..3}; do
            echo "‚è≥ Attempt $i of 3..."
            
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
              -H "x-api-key: $SCHEDULER_API_KEY" \
              "$BACKEND_URL/api/health/wake")
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "‚úÖ Backend is awake! Server responded with status 200"
              echo "üéØ Scheduler will run at midnight UTC (in ~4 minutes)"
              exit 0
            else
              echo "‚ùå Attempt $i failed with status code: $HTTP_CODE"
              if [ $i -lt 3 ]; then
                echo "‚è∞ Retrying in 30 seconds..."
                sleep 30
              fi
            fi
          done

          echo "üö® Failed to wake backend after 3 attempts"
          exit 1

      - name: Verify scheduler readiness
        if: success()
        run: |
          echo "‚úÖ Backend server is awake and ready"
          echo "‚è∞ Current time: $(date -u)"
          echo "üîÑ Scheduler will execute at midnight UTC"
